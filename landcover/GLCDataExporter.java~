package landcover;

import toposwapper.Coordinate;
import toposwapper.LookupManager;
import toposwapper.TopoSwapperException;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.nio.ByteOrder;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.Properties;

public class GLCDataExporter
{
    Coordinate coord;
    Properties params;
    File destFile;
    short[][] noHaloData = new short[3600][3600];

    private final static Logger LOGGER = Logger.getLogger(GLCDataExporter.class.getName());

    public GLCDataExporter(Properties params)
    {
	this.params = params;
    }
    

    public void noHaloWriteGLCDataToDisk(GLCTile glcTile) 
	throws TopoSwapperException
    {
	FileOutputStream fos = null;
	//System.out.println("The value of tile is " + tile);

	try
	    {
		File fileOutput = new File(glcTile.getGeoTiffFileName());
		renameFile(fileOutput);
		fos = new FileOutputStream(destFile,false);
		byte[] origData = glcTile.getData();
		if (ByteOrder.nativeOrder().equals(ByteOrder.BIG_ENDIAN))
		    {
			int maxRowIndex = origData.length-1;
			for (int i = 0;i<3600;i++)
			    {
				for (int j = 0; j <3600;j++)
				    {
					noHaloData[j][i] = 
					    origData[maxRowIndex*3601+j];
					fos.write((noHaloData[j][i] >> 8) & 0xFF);
					fos.write(noHaloData[j][i] & 0xFF);
					
				    }
				maxRowIndex--;
			    }
		    }
		else
		    {
			int maxRowIndex = noHaloData.length-1;
			for (int i = 0;i<3600;i++)
			    {
				for (int j = 0; j <3600;j++)
				    {
					int oneDimIndex = 
					    maxRowIndex*3601+j;
					noHaloData[i][j] = 
					    origData[oneDimIndex];
					fos.write(noHaloData[i][j] & 0xFF);
					fos.write((noHaloData[i][j] >> 8) & 0xFF);
					
				    }
				maxRowIndex--;
			    }
		    }
	    }
	catch (Exception e)
	    {
		e.printStackTrace();
		new TopoSwapperException(e.getMessage());
	    }
	finally
	    {
		try
		    {
			fos.close();
		    }
		catch (Exception e)
		    {
			e.printStackTrace();
		    }
	    }
    }
   

    private void renameFile(File fileOutput) throws IOException
    {
	System.out.println("Renaming file");
	String spatialIndex = coord.getSpatialIndex();
	String destFileName = params.getProperty("srtm_output_dir")+"/"+spatialIndex;
	LOGGER.info("The value of destFileName is " + destFileName);
	String srcFileName = params.getProperty("srtm_output_dir")+"/"+fileOutput.getName();
	LOGGER.info("The value of srcFileName is " + srcFileName);
	File srcFile = new File(srcFileName);
	File destFile = new File(destFileName);
	if (destFile.exists())
	    {
		destFile.exists();
	    }
	Path source = srcFile.toPath();
        Files.move(source, source.resolveSibling(destFileName));
	setDestFile(destFile);
    }


    private void setDestFile(File destFile)
    {
	this.destFile = destFile;
    }
}
